<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hosts</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.28.1/react-bootstrap.min.js"></script>
    <script>
        var Alert = ReactBootstrap.Alert;
    </script>
    <style>
        .modal-container {
            position: relative;
        }

        .modal-container .modal, .modal-container .modal-backdrop {
            position: absolute;
        }
 
    </style>
    <meta name="viewport" content="maximum-scale=1, width=device-width, initial-scale=1">
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">

    var baseUrl = "http://tracker-api.abarruda.com:10101";
    //var baseUrl = "http://loyola.abarruda.com:10101/"


    var Button = ReactBootstrap.Button;
    var OverlayTrigger = ReactBootstrap.OverlayTrigger;
    var Panel = ReactBootstrap.Panel;
    var Popover = ReactBootstrap.Popover;
    var POLL_INTERVAL = 30000;

    var HostBox = React.createClass({

        render: function() {
            return (
                <div className="container-fluid">
                    <div className="row">
                        <div className="col-sm-4">
                            <HostList title="Active Hosts" dataSourceUrl={baseUrl + "/tracker/api/v1/active"} pollInterval={POLL_INTERVAL}/>
                            <HostList title="Inactive Hosts" dataSourceUrl={baseUrl + "/tracker/api/v1/inactive"} pollInterval={POLL_INTERVAL}/>
                        </div>
                    </div>
                </div>
            );
        }
    });

    var HostList = React.createClass({

        getInitialState: function() {
            return {
                data: []};
        },

        loadHostsFromServer: function() {
            $.ajax({
                url: this.props.dataSourceUrl,
                // The following is needed when talking directly to couchDB.
                // Allowing cross domain on the Flask side, so no longer needed
                //dataType: 'jsonp',
                cache: false,
                success: function(data) {
                    var hostList = [];
                    $(data.rows).each(function(index, obj) {
                        hostList.push({id: obj.id, name: obj.value.name, vendor: obj.value.vendor, status: obj.value.status, ip: obj.value.ip, firstSeen: obj.value.firstSeen, lastSeen: obj.value.lastSeen, lastEvent: obj.value.lastEvent});
                    });
                    this.setState({data: hostList});
                }.bind(this),
                error: function(xhr, status, err) {
                    debugger;
                    console.error(this.props.dataSourceUrl, status, err.toString());
                }.bind(this)
            });
        },

        componentDidMount: function() {
            this.loadHostsFromServer();
            setInterval(this.loadHostsFromServer, this.props.pollInterval);
        },

        renderPanelTitle: function() {
            var count = $(this.state.data).length;
            return (
                <div>
                    {this.props.title} <div className="badge">{count}</div>
                </div>
                );
        },

        render: function() {

            var count = $(this.state.data).length;

            var hosts = this.state.data.map(function(host) {
                var style = "primary";
                if (host.status === "INACTIVE") {
                    style = "info"
                }
                return (
                    <Host key={host.id} host={host} style={style}/>
                    );
            });

            return (
                <div className="hostList">
                    <Panel header={this.renderPanelTitle()}>
                            {hosts}
                        
                    </Panel>
                </div>
                );
        }
    });

    var Host = React.createClass({
        getInitialState: function() {
            return {
                open: false,
                timelineExpanded: false,
                showTimelineModal: false,
                timeline: []};
        },

        loadTimelineFromServer: function() {
            var apiUrl = baseUrl + "/tracker/api/v1/" + this.props.host.id + "/event-history/36"

            $.ajax({
                url: apiUrl,
                cache: false,
                success: function(data) {
                    var timeline = [];
                    $(data.rows).each(function(index, obj) {
                        timeline.push({timestamp: obj.timestamp, status: obj.status});
                    });
                    this.setState({timeline: timeline});
                }.bind(this),
                error: function(xhr, status, err) {
                    debugger;
                    console.error(this.props.dataSourceUrl, status, err.toString());
                }.bind(this)
            });
        },

        handleClick: function() {
            this.setState({ open: !this.state.open });
        },


        handleTimelineClick: function() {
            if (this.state.timelineExpanded === false) {
                // This means we're switch from a closed state to an open state,
                // so let's load the timeline data from the server
                this.loadTimelineFromServer();
            }
            this.setState({timelineExpanded: !this.state.timelineExpanded})
        },

        handleTimelineClose: function () {
            this.setState({showTimelineModal: false});
        },

        render: function() {
            var noLastEvent = (typeof this.props.host.lastEvent === "undefined");

            var lastEvent;
            if (!noLastEvent) {
                if (typeof this.props.host.lastEvent.status === "undefined") {
                    lastEvent = "N/A";
                } else {
                    lastEvent = "Became " + this.props.host.lastEvent.status + " at " +  this.props.host.lastEvent.timestamp;
                }
                
            }
            return (
                <div>
                    <Panel header={this.props.host.name} collapsible bsStyle={this.props.style}>
                        Vendor: {this.props.host.vendor}<br />
                        IP Address: {this.props.host.ip}<br />
                        First Seen: {this.props.host.firstSeen}<br />
                        Last Seen: {this.props.host.lastSeen}<br />
                        <br />
                        {lastEvent}<br />
                        <br />
                        
                        <Button bsStyle="link" onClick={this.handleTimelineClick}>Show Timeline</Button><small>(past 36 hours)</small>
                        <TimelinePanel key={this.props.host.id} expanded={this.state.timelineExpanded} 
                            host={this.props.host} timeline={this.state.timeline} />
                    </Panel>
                </div>);
        }
    });

    var TimelinePanel = React.createClass({
        getInitialState: function() {
            return {
                timeline: []
            }
        },

        render: function() {

            var timeline = this.props.timeline.map(function(timeline) {
                var statusLabelClassName = "label";
                var statusGlyphClassName = "glyphicon";

                if (timeline.status === "ACTIVE") {
                    statusLabelClassName += " label-primary"
                    statusGlyphClassName += " glyphicon-chevron-right";
                } else {
                    statusLabelClassName += " label-info"
                    statusGlyphClassName += " glyphicon-chevron-left";
                }

                return(
                        <div key={timeline.timestamp}>
                            <div className={statusGlyphClassName}></div>
                            <div className="glyphicon glyphicon-user" />
                            <div className={statusLabelClassName}>{timeline.status}</div>
                            <div className="label label-default">{timeline.timestamp}</div>
                            <br /><br />
                        </div>
                    );
            });

            return (
                <Panel collapsible expanded={this.props.expanded}>
                    {timeline}
                </Panel>
                );
        }
    });

    ReactDOM.render(
        <HostBox />,
        document.getElementById('content')
        );
    </script>
  </body>
</html>